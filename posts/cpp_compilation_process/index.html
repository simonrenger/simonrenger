<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.6.3"><meta name=author content="Simon Renger"><meta name=description content="In this workshop / how to you learn how the C++ Compilation process works in a nutshell. Before you can start you need to do some form of preps as described in the next step... (This is a workshop created for Breda University of Applied Sciences Games BA Technology Course 2021)"><link rel=alternate hreflang=en-us href=/posts/cpp_compilation_process/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono%7CPermanent+Marker&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-05P56YHX7E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){document.location=url;}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target);}
gtag('js',new Date());gtag('config','G-05P56YHX7E',{});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/img/icon-32.png><link rel=apple-touch-icon type=image/png href=/img/icon-192.png><link rel=canonical href=/posts/cpp_compilation_process/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@kazum93"><meta property="twitter:creator" content="@kazum93"><meta property="og:site_name" content="Simon Renger"><meta property="og:url" content="/posts/cpp_compilation_process/"><meta property="og:title" content="C++ Compilation process | Simon Renger"><meta property="og:description" content="In this workshop / how to you learn how the C++ Compilation process works in a nutshell. Before you can start you need to do some form of preps as described in the next step... (This is a workshop created for Breda University of Applied Sciences Games BA Technology Course 2021)"><meta property="og:image" content="/img/icon-192.png"><meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-12-02T00:00:00+01:00"><meta property="article:modified_time" content="2021-12-02T00:00:00+01:00"><title>C++ Compilation process | Simon Renger</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><span class="text-orange mr-1">Simon</span>Renger</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Simon Renger</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#skilloverview><span>Skills</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/page/services/><span>Services</span></a></li><li class=nav-item><a class="nav-link active" href=/posts/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=/files/Simon_Renger_CV.pdf><span>CV</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>C++ Compilation process</h1><div class=article-metadata><span class=article-date>Dec 2, 2021</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/categories/lecture/>lecture</a>, <a href=/categories/cpp/>cpp</a>, <a href=/categories/gamedev/>gamedev</a></span></div></div><div class=article-container><div class=article-style><blockquote><p>This is a workshop created for <a href=https://www.buas.nl/en/programmes/creative-media-and-game-technologies>Breda University of Applied Sciences</a> 2021 with the original title: <code>C++ Compilation process Workshop 2021</code></p></blockquote><p>In this workshop / how to you learn how the C++ Compilation process works in a nutshell. Before you can start you need to do some form of preps as described in the next step.</p><h2 id=preparations>Preparations</h2><p>In order to participate you need to install the right compiler and linker.</p><p><strong>Windows</strong></p><p>If we have Visual Studio 19/22 installed with the C++ extensions or VS Code with the C++ tooling we have our linker and compiler installed.</p><blockquote><p><strong>Note:</strong> How to use the compiler from the command line follow this guide <a href="https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170</a></p></blockquote><p><strong>Linux</strong> Debain/Ubuntu</p><p>On Linux we need to install the basic build essentials. This includes the default compiler (usually GCC GNU C Compiler) and the linker</p><blockquote><p><strong>Note:</strong> if you want to use the WSL follow these instructions <a href=https://docs.microsoft.com/en-us/windows/wsl/install>https://docs.microsoft.com/en-us/windows/wsl/install</a> and than use the windows store / Microsoft store and download Ubuntu or Debian</p></blockquote><p>Install (gcc):</p><pre><code>sudo apt update
sudo apt install build-essential
gcc --version
</code></pre><p>Install (clang)</p><pre><code>sudo apt update
sudo apt install clang
clang --version
</code></pre><h2 id=overview>Overview</h2><p>The C/C++ compilation process takes one source file at the time and creates a Translation unit of them. Individually they do not now anything of each other! The linker will combine them at the end.</p><p>The compilation process of a translation unit (TU) looks as following:</p><ol><li>Source files are cleaned</li><li>We parse the file and run the pre-processor<ol><li>each introduced include goes into step 1</li><li>All pre-processor directives are removed from the source.</li></ol></li><li>Literal strings and characters are translated</li><li>Compilation takes place of tokens: <em>translation units</em></li><li>Template instanton happens <code>instantiation units</code></li><li>Linking</li></ol><blockquote><p><strong>Note:</strong> Some compilers don&rsquo;t implement instantiation units (also known as <a href=http://docs.oracle.com/cd/E18659_01/html/821-1383/bkagr.html#scrolltoc>template repositories</a> or <a href="http://www-01.ibm.com/support/knowledgecenter/SSXVZZ_12.1.0/com.ibm.xlcpp121.linux.doc/compiler_ref/fcat_template.html?lang=en">template registries</a>) and simply compile each template instantiation at Phase 7 (4), storing the code in the object file where it is implicitly or explicitly requested, and then the linker collapses these compiled instantiations into one at Phase 9 (6). (<a href=https://en.cppreference.com/w/cpp/language/translation_phases>https://en.cppreference.com/w/cpp/language/translation_phases</a>)</p></blockquote><h2 id=pre-processor>Pre-processor</h2><p>Did we not forget the pre-processor?</p><pre><code>#define value 1
// I am a comment
int main(){
int var{value};
}
</code></pre><p>If we now compile this we can store the pre processor output in a file:</p><p><strong>Windows</strong></p><pre><code>cl.exe /c /P preprocessor.cpp
</code></pre><p><strong>Linux</strong></p><pre><code>gcc preprocessor.cpp -E&gt;preprocessor.i
clang preprocessor.cpp -E&gt;preprocessor.i
</code></pre><p>We now see a file names: <code>preprocessor.i</code> :</p><pre><code>#line 1 &quot;preprocessor.cpp&quot;

int main(){
int var{1};
}
</code></pre><p>The line <code>int var{value};</code> has been changed to <code>int var{1};</code> and the <code>#define value 1</code> was erased! Also the comment was removed!</p><h3 id=inclusion>Inclusion</h3><p>If you include any header file the pre processor will include them recursively.</p><pre><code>headerA.hpp
struct StructA{};
headerB.hpp
#include &quot;headerA.hpp&quot;
struct StructB{};
source.cpp
#include &quot;headerB.hpp&quot;

int main(){
    StructA struct_a{};
}
</code></pre><p>If we now compile this we can store the pre processor output in a file:</p><p><strong>Windows</strong></p><pre><code>cl.exe /c /P source.cpp
</code></pre><p><strong>Linux</strong></p><pre><code class=language-c>gcc preprocessor.cpp -E&gt;preprocessor.i
clang preprocessor.cpp -E&gt;preprocessor.i
</code></pre><p>We now see a file names: <code>source.i</code> or <code>linux</code>:</p><pre><code class=language-cpp># 1 &quot;preprocessor/source.cpp&quot;
# 1 &quot;&lt;built-in&gt;&quot; 1
# 1 &quot;&lt;built-in&gt;&quot; 3
# 383 &quot;&lt;built-in&gt;&quot; 3
# 1 &quot;&lt;command line&gt;&quot; 1
# 1 &quot;&lt;built-in&gt;&quot; 2
# 1 &quot;preprocessor/source.cpp&quot; 2
# 1 &quot;preprocessor/headerB.hpp&quot; 1
# 1 &quot;preprocessor/headerA.hpp&quot; 1
struct StructA{};
# 2 &quot;preprocessor/headerB.hpp&quot; 2
struct StructB{};
# 2 &quot;preprocessor/source.cpp&quot; 2

int main(){
    StructA struct_a{};
}
</code></pre><h3 id=header-guards>Header Guards</h3><p>As you could see Includes are recursive this can lead to cycle includes.</p><pre><code>cycleA.hpp
#include &quot;cycleB.hpp&quot;
cycleB.hpp
#include &quot;cycleA.hpp&quot;
</code></pre><p>if we now compile this with (clang, gcc, msvc)</p><p><strong>Windows</strong></p><pre><code>cl.exe /c /P cycleA.cpp
</code></pre><p><strong>Linux</strong></p><pre><code>clang cycleA.hpp -E&gt;cycleA.i
gcc cycleA.hpp -E&gt;cycleA.i
</code></pre><p>Result will be:</p><pre><code class=language-bash>user@MININT-DAH9RK3:/mnt/d/cpplecture$ clang cycleA.hpp -E&gt;preprocessor.i
In file included from preprocessor/cycleA.hpp:1:
In file included from preprocessor/cycleB.hpp:1:
In file included from preprocessor/cycleA.hpp:1:
[edit by Simon replaced 200 more of `In file included from preprocessor/cycleA.hpp:1:` with this line]
preprocessor/cycleB.hpp:1:10: error: #include nested too deeply
#include &quot;cycleA.hpp&quot;
</code></pre><p>if we add now a <code>#pragma once</code> to <code>cycleB.hpp</code></p><pre><code class=language-c>#pragma once
#include &quot;cycleA.hpp&quot;
</code></pre><p>the compiler (clang, gcc, msvc) will run and spill out:</p><p><strong>Windows</strong></p><pre><code>cl.exe /c /P cycleA.cpp
</code></pre><p><strong>Linux</strong></p><pre><code>clang cycleA.hpp -E&gt;cycleA.i
gcc cycleA.hpp -E&gt;cycleA.i
</code></pre><p>The result:</p><pre><code class=language-c># 1 &quot;preprocessor/cycleA.hpp&quot;
# 1 &quot;&lt;built-in&gt;&quot; 1
# 1 &quot;&lt;built-in&gt;&quot; 3
# 383 &quot;&lt;built-in&gt;&quot; 3
# 1 &quot;&lt;command line&gt;&quot; 1
# 1 &quot;&lt;built-in&gt;&quot; 2
# 1 &quot;preprocessor/cycleA.hpp&quot; 2
# 1 &quot;preprocessor/cycleB.hpp&quot; 1

# 1 &quot;preprocessor/cycleA.hpp&quot; 1
# 2 &quot;preprocessor/cycleB.hpp&quot; 2
# 1 &quot;preprocessor/cycleA.hpp&quot; 2
</code></pre><h2 id=compile-a-source-file>Compile a source file</h2><p>The basic source file:</p><pre><code class=language-c++>int main(){}
</code></pre><p>Invoke the compiler:</p><p><strong>Windows</strong></p><pre><code>cl.exe /c empty.cpp
</code></pre><p><strong>Linux</strong></p><pre><code>clang -c empty.cpp
gcc -c empty.cpp
</code></pre><p>This generates a object file. <code>.obj</code> or <code>.o</code> on linux.</p><h2 id=assembler>Assembler</h2><p>This way we skipped one step: The assembler! This is the step in which the compiler creates a assembly representation for your target platform!</p><p>To get the output that is used to generate the Object File you must tell the compiler to generate the assemble output for you:</p><p><strong>Windows</strong></p><pre><code>cl.exe /FAs /c empty.cpp
</code></pre><p>This will produce as <code>.asm</code> file with your assembly</p><p><strong>Linux</strong></p><pre><code>clang -S 
</code></pre><p>This will produce a <code>.s</code> file with your assembly.</p><h3 id=inspecting-a-object-file>Inspecting a object file</h3><p>Normally the compiler does the assembler step automatically and generates the object file. A object file contains all important information about the current translation unit. The most important question is: Which external objects are references? This is important since a TU does not know anything about other TU&rsquo;s! The linker needs this information later to stitch the program together!</p><blockquote><p><strong>Note:</strong> A Object file is on windows and Linux Systems different. Since on Windows it is a COFF generated by Microsoft C compiler and on Linux ELF/DWARF.</p><ul><li><a href=https://en.wikipedia.org/wiki/COFF>https://en.wikipedia.org/wiki/COFF</a></li><li><a href=https://en.wikipedia.org/wiki/Executable_and_Linkable_Format>https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></li></ul></blockquote><p>We can view a Object file with:</p><p><strong>Windows</strong></p><p>More infos: <a href="https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-options?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-options?view=msvc-170</a></p><pre><code class=language-bash>DUMPBIN.EXE /ALL empty.obj
</code></pre><p><strong>Linux</strong></p><pre><code class=language-bash>objectdump -a empty.o
</code></pre><blockquote><p><strong>Note:</strong> There could be a entire lecture about this! <a href="https://www.youtube.com/watch?v=a5L66zguFe4">https://www.youtube.com/watch?v=a5L66zguFe4</a></p></blockquote><h2 id=linker>Linker</h2><p>In this stage of the process multiple object files will be combined to a executable!</p><h3 id=executable>Executable</h3><p>Lets build a game:</p><pre><code>/game/main.cpp
/lib/engine.hpp
/lib/engine.cpp
main.cpp
#include &quot;engine.hpp&quot;

int main(){
    engine{create()};
}
engine.hpp
struct engine{
// stuff
};

[[nodiscard]] engine create() noexcept;
engine.cpp
#include &quot;engine.hpp&quot;

[[nodiscard]] engine create() noexcept{
    return {};
}
</code></pre><p>Let us compile the game:</p><p><strong>Windows</strong></p><pre><code class=language-bash>cd /game
cl.exe \c main.cpp
</code></pre><p><strong>Linux</strong></p><pre><code>cd /game
clang -c main.cpp -std=c++17
gcc -c main.cpp -std=c++17
</code></pre><p>This will spill out a compile error!</p><pre><code>PS D:\cpplecture\linker\game&gt; cl.exe /c main.cpp
Microsoft (R) C/C++ Optimizing Compiler Version 19.29.30136 for x86
Copyright (C) Microsoft Corporation.  All rights reserved.
main.cpp
main.cpp(1): fatal error C1083: Cannot open include file: 'engine.hpp': No such file or directory
</code></pre><blockquote><p><strong>Note:</strong> On Linux we will have the same result!</p></blockquote><p>We need to tell the compiler where the header file is! <code>/I[..]</code> or <code>-I[..]</code></p><pre><code>PS D:\cpplecture\linker\game&gt; cl.exe /c main.cpp /I ../lib
</code></pre><p>This works! we have a obj file!</p><p>Let us investigate what is in the object file: We run <code>DUMPBIN.EXE /ALL main.obj</code></p><pre><code>PS D:\cpplecture\linker\game&gt; DUMPBIN.EXE /ALL main.obj
Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file main.obj

File Type: COFF OBJECT

FILE HEADER VALUES
             14C machine (x86)
               4 number of sections
        61A8E6C9 time date stamp Thu Dec  2 16:31:21 2021
             193 file pointer to symbol table
               D number of symbols
               0 size of optional header
               0 characteristics

SECTION HEADER #1
.drectve name
       0 physical address
       0 virtual address
      2F size of raw data
      B4 file pointer to raw data (000000B4 to 000000E2)
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
  100A00 flags
         Info
         Remove
         1 byte align

RAW DATA #1
  00000000: 20 20 20 2F 44 45 46 41 55 4C 54 4C 49 42 3A 22     /DEFAULTLIB:&quot;
  00000010: 4C 49 42 43 4D 54 22 20 2F 44 45 46 41 55 4C 54  LIBCMT&quot; /DEFAULT
  00000020: 4C 49 42 3A 22 4F 4C 44 4E 41 4D 45 53 22 20     LIB:&quot;OLDNAMES&quot;

   Linker Directives
   -----------------
   /DEFAULTLIB:LIBCMT
   /DEFAULTLIB:OLDNAMES

SECTION HEADER #2
.debug$S name
       0 physical address
       0 virtual address
      74 size of raw data
      E3 file pointer to raw data (000000E3 to 00000156)
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
42100040 flags
         Initialized Data
         Discardable
         1 byte align
         Read Only

RAW DATA #2
  00000000: 04 00 00 00 F1 00 00 00 67 00 00 00 29 00 01 11  ....ñ...g...)...
  00000010: 00 00 00 00 44 3A 5C 63 70 70 6C 65 63 74 75 72  ....D:\cpplectur
  00000020: 65 5C 6C 69 6E 6B 65 72 5C 67 61 6D 65 5C 6D 61  e\linker\game\ma
  00000030: 69 6E 2E 6F 62 6A 00 3A 00 3C 11 01 22 00 00 07  in.obj.:.&lt;..&quot;...
  00000040: 00 13 00 1D 00 B8 75 00 00 13 00 1D 00 B8 75 00  .....¸u......¸u.
  00000050: 00 4D 69 63 72 6F 73 6F 66 74 20 28 52 29 20 4F  .Microsoft (R) O
  00000060: 70 74 69 6D 69 7A 69 6E 67 20 43 6F 6D 70 69 6C  ptimizing Compil
  00000070: 65 72 00 00                                      er..

SECTION HEADER #3
.text$mn name
       0 physical address
       0 virtual address
      12 size of raw data
     157 file pointer to raw data (00000157 to 00000168)
     169 file pointer to relocation table
       0 file pointer to line numbers
       1 number of relocations
       0 number of line numbers
60500020 flags
         Code
         16 byte align
         Execute Read

RAW DATA #3
  00000000: 55 8B EC 51 E8 00 00 00 00 88 45 FF 33 C0 8B E5  U.ìQè.....Eÿ3À.å
  00000010: 5D C3                                            ]Ã

RELOCATIONS #3
                                                Symbol    Symbol
 Offset    Type              Applied To         Index     Name
 --------  ----------------  -----------------  --------  ------
 00000005  REL32                      00000000         9  ?create@@YA?AUengine@@XZ (struct engine __cdecl create(void))

SECTION HEADER #4
 .chks64 name
       0 physical address
       0 virtual address
      20 size of raw data
     173 file pointer to raw data (00000173 to 00000192)
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
     A00 flags
         Info
         Remove
         (no align specified)

RAW DATA #4
  00000000: 23 07 66 15 27 1A BF 1A FD FD 6A 15 8D E6 A5 E2  #.f.'.¿.ýýj..æ¥â
  00000010: 42 E8 D5 96 AB C2 64 E1 00 00 00 00 00 00 00 00  BèÕ.«Âdá........

COFF SYMBOL TABLE
000 010575B8 ABS    notype       Static       | @comp.id
001 80010191 ABS    notype       Static       | @feat.00
002 00000002 ABS    notype       Static       | @vol.md
003 00000000 SECT1  notype       Static       | .drectve
    Section length   2F, #relocs    0, #linenums    0, checksum        0
005 00000000 SECT2  notype       Static       | .debug$S
    Section length   74, #relocs    0, #linenums    0, checksum        0
007 00000000 SECT3  notype       Static       | .text$mn
    Section length   12, #relocs    1, #linenums    0, checksum 6BED4AA5
009 00000000 UNDEF  notype ()    External     | ?create@@YA?AUengine@@XZ (struct engine __cdecl create(void))
00A 00000000 SECT3  notype ()    External     | _main
00B 00000000 SECT4  notype       Static       | .chks64
    Section length   20, #relocs    0, #linenums    0, checksum        0

String Table Size = 0x1D bytes

  Summary

          20 .chks64
          74 .debug$S
          2F .drectve
          12 .text$mn
</code></pre><p>Under <code>RELOCATIONS #3</code> we find something intersting:</p><pre><code>                                      Symbol    Symbol
 Offset    Type  Applied   To         Index     Name

00000005  REL32 00000000               9       ?create@@YA?AUengine@@XZ (struct engine __cdecl create(void))
</code></pre><p>This somehow looks like: <code>[[nodiscard ]] engine create() noexcept</code>. That is correct! In C++ we mangle names we (the compiler) renames the name after they implementation defined scheme (yes clang uses a different method than msvc! GREAT!)</p><blockquote><p>The reason for this is that we can have overloads (in short!) more infos here <a href=https://www.geeksforgeeks.org/extern-c-in-c/>https://www.geeksforgeeks.org/extern-c-in-c/</a></p></blockquote><p>This means the compiler stores in the object file all sorts of interesting information about this TU (translation unit). In this case the compiler stores that at a offset of 5 the symbol <code>?create@@YA?AUengine@@XZ (struct engine __cdecl create(void))</code> needs to be relocated! Relocated means that it can be found external!</p><p>Enough of this inspection lets us create our executable!</p><pre><code>PS D:\cpplecture\linker\game&gt; link.exe  main.obj
</code></pre><p>This also leads to a error!</p><pre><code class=language-cpp>Microsoft (R) Incremental Linker Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.

main.obj : error LNK2019: unresolved external symbol &quot;struct engine __cdecl create(void)&quot; (?create@@YA?AUengine@@XZ) referenced in function _main
main.exe : fatal error LNK1120: 1 unresolved externals
</code></pre><p>Do we remember:</p><blockquote><p>This means the compiler stores in the object file all sorts of interesting information about this TU (translation unit). In this case the compiler stores that at a offset of 5 the symbol <code>?create@@YA?AUengine@@XZ (struct engine __cdecl create(void))</code> needs to be relocated! Relocated means that it can be found external!</p></blockquote><p>This is what it means in practice! Oh right we did not compile <code>lib/engine.cpp</code> Let us fix this!</p><pre><code>PS D:\cpplecture\linker\game&gt; cd ..
PS D:\cpplecture\linker&gt; cd lib
PS D:\cpplecture\linker\lib&gt; cl.exe /c engine.cpp
</code></pre><p>Now we have a <code>lib/engine.obj</code></p><p>cool lets go back to our game and try again!</p><pre><code>PS D:\cpplecture\linker\game&gt; link.exe  main.obj
Microsoft (R) Incremental Linker Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.

main.obj : error LNK2019: unresolved external symbol &quot;struct engine __cdecl create(void)&quot; (?create@@YA?AUengine@@XZ) referenced in function _main
main.exe : fatal error LNK1120: 1 unresolved externals
</code></pre><p>We get the same error! But we compiled the other thing&mldr;</p><p>This time we have to remmeber:</p><blockquote><p>Translation Units are looked at individually and main.obj does not know anything of engine.obj!</p></blockquote><p>This means we need to tell the linker <strong>where</strong> our external symbols are living!</p><pre><code>PS D:\cpplecture\linker\game&gt; link.exe  main.obj ../lib/engine.obj
</code></pre><p>This works we get out executable!</p><h3 id=library>Library</h3><p>In reality projects are really big and sometimes we split them into libraries. In general a library is nothing else than a collection of object files the linker can use statically or dynamically!</p><blockquote><p><strong>Note:</strong> This overview will not touch the dynamic approach since this is a huge topic on its own!</p></blockquote><p>Lets upgrade our &ldquo;engine&rdquo; example a bit:</p><pre><code>engine.hpp
#pragma once
using cstring = const char*;

template&lt;typename T&gt;
struct container_t{
    T* items;
    unsigned int num_items;
    unsigned int capacity;
};


struct entity_t {
    unsigned int id;
};


struct world_t{
    container_t&lt;entity_t&gt; entities;
};


struct engine_t{
    void update(double dt);
    entity_t spawn();
    world_t world;    
};

[[nodiscard ]] engine_t create() noexcept;
#include &quot;engine.hpp&quot;

[[nodiscard]] engine_t create() noexcept{
    engine_t e{};
    e.world.entities.items = new entity_t[100];
    e.world.entities.capacity = 100;
    return e;
}

entity_t engine_t::spawn(){
    if(world.entities.num_items == world.entities.capacity){
        // magic
    }else{
        world.entities.items[world.entities.num_items] = {world.entities.num_items};
    }
    return {world.entities.num_items};
}

void engine_t::update(double dt){
    //...
}
</code></pre><p>Let us add a json parser &mldr; every good C++ project needs one!</p><pre><code>json.hpp
#pragma once

using cstring = const char*;

struct string_view{
    cstring data_ptr;
    unsigned int len;
};

struct json{
//..
};

struct json_object{
//..
};

struct json_array{
    json_object* objects;
    unsigned int len;
};

[[nodiscard]] json parse(cstring path) noexcept;

[[nodiscard]] json_object get_object(const json&amp; root,cstring key) noexcept;

[[nodiscard]] json_array get_array(const json&amp; root,cstring key) noexcept;

[[nodiscard]] string_view get_string(const json&amp; root,cstring key) noexcept;

[[nodiscard]] double get_number(const json&amp; root,cstring key) noexcept;
#include &quot;json.hpp&quot;

[[nodiscard]] json parse(cstring path) noexcept{
    return {};
}

[[nodiscard]] json_object get_object(const json&amp; root,cstring key) noexcept{
    return {};
}

[[nodiscard]] json_array get_array(const json&amp; root,cstring key) noexcept{
    return {};
}

[[nodiscard]] string_view get_string(const json&amp; root,cstring key) noexcept{
    return {};
}

[[nodiscard]] double get_number(const json&amp; root,cstring key) noexcept{
    return {};
}
</code></pre><p><strong>The game:</strong></p><pre><code>level.hpp
#include &quot;engine.hpp&quot;

struct level{
    world_t world;
};


 void load(engine_t&amp; engine, cstring level) noexcept;
level.cpp
#include &quot;engine.hpp&quot;
#include &quot;json.hpp&quot;

 void load(engine_t&amp; engine, cstring level) noexcept{
    json l{parse(level)};
}
main.cpp
#include &quot;engine.hpp&quot;
#include &quot;level.hpp&quot;

int main(){
    engine_t core{create()};
    load(core,&quot;Test_level.json&quot;);
}
</code></pre><p>Let us build a <code>.lib</code> or <code>.a</code> file.</p><blockquote><p><strong>Note</strong>: again a static lib is nothing else than a collection (or archive) or object files. This is why the name on Linux is .a which stands for <em>archive</em> and the tool on Linux for creating one is called <code>ar</code> <a href=https://linux.die.net/man/1/ar>https://linux.die.net/man/1/ar</a></p></blockquote><p>At first we need to compile both of our translation units (source files):</p><p><strong>Windows</strong></p><pre><code>cd lib
PS D:\cpplecture\linker\lib&gt; cl.exe /c engine.cpp json.cpp
--&gt; engine.obj
--&gt; json.obj
</code></pre><p><strong>Linux</strong></p><pre><code>clang -c engine.cpp json.cpp -std=c++17
gcc -c engine.cpp json.cpp -std=c++17
--&gt; json.o
--&gt; engine.o
</code></pre><p>Now we need to stich those object files together this can be done via the <code>lib.exe</code> or the <code>ar</code> tool on linux:</p><p><strong>Windows</strong></p><pre><code>lib.exe .\json.obj .\engine.obj /out:engine.lib
</code></pre><blockquote><p><a href="https://docs.microsoft.com/en-us/cpp/build/reference/overview-of-lib?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/reference/overview-of-lib?view=msvc-170</a></p></blockquote><p><strong>Linux</strong></p><pre><code>ar rc engine.a json.o engine.o
</code></pre><blockquote><p><a href=https://llvm.org/docs/CommandGuide/llvm-ar.html>https://llvm.org/docs/CommandGuide/llvm-ar.html</a> or <a href=https://linux.die.net/man/1/ar>https://linux.die.net/man/1/ar</a></p></blockquote><p>Now we have a lib: <code>engine.lib</code> or <code>engine.a</code> and we can now link against this with <code>ld</code> (on Linux) or <code>link.exe</code> on windows just like we were to link object files:</p><p><strong>Windows</strong></p><pre><code> cl.exe main.cpp level.cpp /c /I ../lib
 link.exe .\main.obj .\level.obj ../lib/engine.lib /out:game.exe
 --&gt; game.exe
</code></pre><p><strong>Linux</strong></p><pre><code>clang main.cpp level.cpp -c -I ../lib
ld .\main.o .\level.o ../lib/engine.a -o game
 --&gt; game
</code></pre><h2 id=extra>Extra</h2><p>If we now inspect the <code>engine.obj</code></p><pre><code>PS D:\cpplecture\linker\game&gt; DUMPBIN.EXE /RELOCATIONS engine.lib
Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file engine.lib

File Type: LIBRARY

RELOCATIONS #3
                                                Symbol    Symbol
 Offset    Type              Applied To         Index     Name
 --------  ----------------  -----------------  --------  ------
 00000077  REL32             00000000         9  ??_U@YAPAXI@Z (void * __cdecl operator new[](unsigned int))
</code></pre><p>and for <code>main.obj</code></p><pre><code>PS D:\cpplecture\linker\game&gt; DUMPBIN.EXE /RELOCATIONS main.obj
Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file main.obj

File Type: COFF OBJECT

RELOCATIONS #4
                                                Symbol    Symbol
 Offset    Type              Applied To         Index     Name
 --------  ----------------  -----------------  --------  ------
 0000000B  REL32             00000000         C  ?create@@YA?AUengine_t@@XZ (struct engine_t __cdecl create(void))
 00000036  DIR32             00000000         9  $SG2851
 0000003F  REL32             00000000         D  ?load@@YAXAAUengine_t@@PBD@Z (void __cdecl load(struct engine_t &amp;,char const *))
</code></pre><p>We have 3:</p><table><thead><tr><th>Symbol</th><th></th></tr></thead><tbody><tr><td><code>?create@@YA?AUengine_t@@XZ (struct engine_t __cdecl create(void))</code></td><td><code>[[nodiscard]] engine_t create() noexcept</code></td></tr><tr><td>$SG2851</td><td>dunno</td></tr><tr><td><code>?load@@YAXAAUengine_t@@PBD@Z (void __cdecl load(struct engine_t &,char const *))</code></td><td><code>void load(engine_t& engine, cstring level) noexcept</code></td></tr></tbody></table><p>If we now look at what symbols we can find in <code>engine.lib</code>:</p><pre><code>PS D:\cpplecture\linker\game&gt; DUMPBIN.EXE /SYMBOLS engine.lib
Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file engine.lib

File Type: LIBRARY

COFF SYMBOL TABLE
000 010575B8 ABS    notype       Static       | @comp.id
001 80010191 ABS    notype       Static       | @feat.00
002 00000002 ABS    notype       Static       | @vol.md
003 00000000 SECT1  notype       Static       | .drectve
    Section length   2F, #relocs    0, #linenums    0, checksum        0
005 00000000 SECT2  notype       Static       | .debug$S
    Section length   78, #relocs    0, #linenums    0, checksum        0
007 00000000 SECT3  notype       Static       | .text$mn
    Section length   A9, #relocs    1, #linenums    0, checksum  47C05A6
009 00000000 UNDEF  notype ()    External     | ??_U@YAPAXI@Z (void * __cdecl operator new[](unsigned int))
00A 00000000 SECT3  notype ()    External     | ?update@engine_t@@QAEXN@Z (public: void __thiscall engine_t::update(double))
00B 00000010 SECT3  notype ()    External     | ?spawn@engine_t@@QAE?AUentity_t@@XZ (public: struct entity_t __thiscall engine_t::spawn(void))
00C 00000060 SECT3  notype ()    External     | ?create@@YA?AUengine_t@@XZ (struct engine_t __cdecl create(void))
00D 00000000 SECT4  notype       Static       | .chks64
    Section length   20, #relocs    0, #linenums    0, checksum        0

String Table Size = 0x6B bytes

COFF SYMBOL TABLE
000 010575B8 ABS    notype       Static       | @comp.id
001 80010191 ABS    notype       Static       | @feat.00
002 00000002 ABS    notype       Static       | @vol.md
003 00000000 SECT1  notype       Static       | .drectve
    Section length   2F, #relocs    0, #linenums    0, checksum        0
005 00000000 SECT2  notype       Static       | .debug$S
    Section length   74, #relocs    0, #linenums    0, checksum        0
007 00000000 SECT3  notype       Static       | .text$mn
    Section length   67, #relocs    0, #linenums    0, checksum 789BEE7A
009 00000000 SECT3  notype ()    External     | ?parse@@YA?AUjson@@PBD@Z (struct json __cdecl parse(char const *))
00A 00000010 SECT3  notype ()    External     | ?get_object@@YA?AUjson_object@@ABUjson@@PBD@Z (struct json_object __cdecl get_object(struct json const &amp;,char const *))
00B 00000020 SECT3  notype ()    External     | ?get_array@@YA?AUjson_array@@ABUjson@@PBD@Z (struct json_array __cdecl get_array(struct json const &amp;,char const *))
00C 00000040 SECT3  notype ()    External     | ?get_string@@YA?AUstring_view@@ABUjson@@PBD@Z (struct string_view __cdecl get_string(struct json const &amp;,char const *))
00D 00000060 SECT3  notype ()    External     | ?get_number@@YANABUjson@@PBD@Z (double __cdecl get_number(struct json const &amp;,char const *))
00E 00000000 UNDEF  notype       External     | __fltused
00F 00000000 SECT4  notype       Static       | .rdata
    Section length    8, #relocs    0, #linenums    0, checksum        0, selection    2 (pick any)
011 00000000 SECT4  notype       External     | __real@0000000000000000
012 00000000 SECT5  notype       Static       | .chks64
    Section length   28, #relocs    0, #linenums    0, checksum        0

String Table Size = 0xE6 bytes
</code></pre><p>We get the list of all symbols in both object files: <code>engine.obj</code> and <code>json.obj</code></p><h2 id=references>References:</h2><ul><li><a href="https://docs.microsoft.com/en-us/cpp/build/reference/overview-of-lib?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/reference/overview-of-lib?view=msvc-170</a></li><li><a href=https://llvm.org/docs/CommandGuide/llvm-ar.html>https://llvm.org/docs/CommandGuide/llvm-ar.html</a></li><li><a href=https://mottosso.gitbooks.io/clang/content/building_a_static_library.html>https://mottosso.gitbooks.io/clang/content/building_a_static_library.html</a></li><li><a href=https://gist.github.com/jsanchezuy/23b1fc8c592455f1bb84>https://gist.github.com/jsanchezuy/23b1fc8c592455f1bb84</a></li><li><a href=https://man7.org/linux/man-pages/man1/objdump.1.html>https://man7.org/linux/man-pages/man1/objdump.1.html</a></li><li><a href=https://www.computerhope.com/unix/uld.htm>https://www.computerhope.com/unix/uld.htm</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/build/reference/compiler-options?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/reference/compiler-options?view=msvc-170</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170</a></li><li><a href=https://linux.die.net/man/1/ar>https://linux.die.net/man/1/ar</a></li><li><a href=https://en.cppreference.com/w/cpp/language/translation_phases>https://en.cppreference.com/w/cpp/language/translation_phases</a></li><li><a href=https://en.wikipedia.org/wiki/COFF>https://en.wikipedia.org/wiki/COFF</a></li><li><a href=https://en.wikipedia.org/wiki/Executable_and_Linkable_Format>https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-options?view=msvc-170">https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-options?view=msvc-170</a></li><li><a href="https://www.youtube.com/watch?v=a5L66zguFe4">https://www.youtube.com/watch?v=a5L66zguFe4</a> (CppCon 2017: Michael Spencer “My Little Object File: How Linkers Implement C++”)</li><li><a href=https://www.geeksforgeeks.org/extern-c-in-c/>https://www.geeksforgeeks.org/extern-c-in-c/</a></li><li><a href="https://www.ibm.com/docs/en/i/7.2?topic=linkage-name-mangling-c-only">https://www.ibm.com/docs/en/i/7.2?topic=linkage-name-mangling-c-only</a></li><li><a href=http://web.mit.edu/tibbetts/Public/inside-c/www/mangling.html>http://web.mit.edu/tibbetts/Public/inside-c/www/mangling.html</a></li></ul></div><div class=article-tags><a class="badge badge-light" href=/tags/lecture/>lecture</a>
<a class="badge badge-light" href=/tags/gamedev/>gamedev</a>
<a class="badge badge-light" href=/tags/github/>github</a>
<a class="badge badge-light" href=/tags/cpp/>cpp</a>
<a class="badge badge-light" href=/tags/workshop/>workshop</a></div><div class="media author-card content-widget-hr"><img class="portrait mr-3" src="https://s.gravatar.com/avatar/f22f4c23159501cef949d7d9c18c0426?s=200')" alt=Avatar><div class=media-body><h5 class=card-title><a href=/>Simon Renger</a></h5><h6 class=card-subtitle>Engine and Tools programming Master Student</h6><p class=card-text>Write programs that do one thing and do it well. Write programs to work together — McIlroy Unix philosophy</p><ul class=network-icon aria-hidden=true><li><a href=mailto:simon.renger@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://www.linkedin.com/in/simon-renger-18873b163/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=https://github.com/simonrenger target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://twitter.com/kazum93 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li></ul></div></div><div class="article-widget content-widget-hr"><h3>Related</h3><ul><li><a href=/project/themachinery/>Internship at OurMachinery</a></li><li><a href=/talk/imposter-effect-lightning-talk-meetingcpp19/>Imposter Effect Lightning Talk Meetingcpp 2019</a></li><li><a href=/project/tbsg/>“Tomorrow Engine“</a></li><li><a href=/project/tutoring/>Tutoring</a></li></ul></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=true;</script><script>const search_config={"indexURI":"/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No results found","placeholder":"Search...","results":"results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.3227ab49eed49815d1b4ba40154f74e7.js></script><div class=container><footer class=site-footer><p class=powered-by>© Simon Renger 2022 &#183;
Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>